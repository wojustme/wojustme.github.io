---
layout: post
title: "JVMå†…å­˜æ¨¡å‹æ¦‚è¦"
date: "2017-07-25 17:12:27 +0800"
categories: JVMå­¦ä¹ 
tags: JVM
excerpt: JVMå­¦ä¹ -JVMå†…å­˜æ¨¡å‹ä¸€äº›åè¯è§£æ
mathjax: true
---

* content
{:toc}

## å•¥ä¹Ÿä¸è¯´ï¼Œçœ‹å›¾è¯´è¯

![image](../../../../public/img/jvm/JVMå†…å­˜ä¸­å„ä¸ªåŒºçš„ç»“æ„.png)

åœ¨å¤šæ ¸å¤§è¡Œå…¶é“çš„ä»Šå¤©ï¼Œå¤šçº¿ç¨‹ä¸å¿…å¤šè¯´ã€‚æŒ‰ç…§çº¿ç¨‹ç§æœ‰æ€§ï¼Œåˆ’åˆ†ä¸ºä¸¤ä¸ªä¸»è¦åŒºåŸŸçº¿ç¨‹å…±äº«åŒºã€çº¿ç¨‹ç§æœ‰åŒº:

1. çº¿ç¨‹å…±äº«--æ–¹æ³•åŒº => çº¿ç¨‹å…±äº«ï¼Œå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ï¼ˆ1.7ååœ¨å †ï¼‰ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç 
2. çº¿ç¨‹å…±äº«--Javaå † => å­˜æ”¾æ‰€æœ‰å¯¹è±¡å®ä¾‹
3. çº¿ç¨‹ç§æœ‰--è™šæ‹Ÿæœºæ ˆ => å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€å‡ºå£
4. çº¿ç¨‹ç§æœ‰--ç¨‹åºè®¡æ•°å™¨ => å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤åœ°å€
5. çº¿ç¨‹ç§æœ‰--æœ¬åœ°æ–¹æ³•åŒº => æ‰§è¡Œnativeæ–¹æ³•åŒºåŸŸ

å…¶å®è¿˜å°‘ä¸¤ç§åŒºåŸŸï¼š**å¸¸é‡æ± **å’Œ**ç›´æ¥å†…å­˜**ã€‚
1. å¸¸é‡æ±  => æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ï¼Œé‚£ä¹ˆæ˜¾ç„¶å°±æ˜¯çº¿ç¨‹å…±äº«çš„
2. ç›´æ¥å†…å­˜ => NIOä¸­çš„Bufferç¼“å†²åŒºï¼Œçº¿ç¨‹ç§æœ‰

## å¸¸é‡æ± 

ä¸ªäººè§‰å¾—å¸¸é‡æ± è¿™ä¸€éƒ¨åˆ†æœ€å¥½ç†è§£ï¼Œå°±å…ˆæ€»ç»“äº†ï¼Œä¸‹åˆ—ä»£ç æŒºèƒ½è¯´æ˜é—®é¢˜çš„ã€‚

{% highlight Java %}
// Conf1.java
public class Conf1 {
  public static String name1 = "hello";
  public static String name2 = "hello";
  public static String name3 = "he" + "llo";
  public static String name4 = "he" + new String("llo");
  public static String name5;
  public static String name6;
  static {
    name5 = "hello";
    name6 = getName6();
  }
  public static String getName6() {
    return "hello";
  }
}
// Conf2.java
public class Conf2 {
  public static String name1 = "hello";
}
// Main.java
public class Main {
  public static void main(String[] args) {
    System.out.println(Conf1.name1 == Conf1.name2); // true
    System.out.println(Conf1.name1 == Conf1.name3); // true
    System.out.println(Conf1.name1 == Conf1.name4); // false
    System.out.println(Conf1.name1 == Conf1.name5); // true
    System.out.println(Conf1.name1 == Conf1.name6); // true
    System.out.println(Conf1.name1 == Conf2.name1); // true
  }
}
{% endhighlight %}

1. å½“è¯¥Mainè¿è¡Œæ—¶ï¼ŒJVMè£…è½½Conf1å’ŒConf2ç±»ï¼Œåˆ†åˆ«å¯¹å…¶è§£æã€åˆ†æå¾—å‡ºå«æœ‰"hello"è¿™ä¸ªå­—ç¬¦ä¸²å¸¸é‡
2. å…¶ä¸­Conf1çš„name1, name2, name3, name5, name6, ä»¥åŠConf2çš„name1éƒ½æ‰§è¡ŒåŒä¸€ä¸ªå¸¸é‡helloçš„å†…å­˜åœ°å€ï¼Œæ‰€ä»¥Conf1.name1 == Conf1.name2 == Conf1.name3 == Conf1.name5 == Conf1.name6 == Conf2.name1
3. è€ŒConf1ä¸­çš„name4ç”¨äº†new Stringï¼ŒæŒ‡å‘äº†æ–°çš„å†…å­˜åœ°å€ï¼Œæ‰€ä»¥ä¸å¯èƒ½è·Ÿå…¶ä»–çš„nameç›¸ç­‰äº†
4. æ³¨æ„çš„æ˜¯ï¼Œå¸¸é‡æ± æ˜¯è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œå³å¯ä»¥å¤šä¸ªJavaæ–‡ä»¶ä¸­å…±äº«ä¸€ä¸ªå¸¸é‡æ± ï¼Œä¸ç±»ä¿¡æ¯æ— å…³


## è™šæ‹Ÿæœºæ ˆ--Javaæ ˆ(å°é‡ç‚¹)

**çº¿ç¨‹å®‰å…¨**ã€æ ˆå¸§(å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€è¿æ¥ã€æ–¹æ³•è¿”å›åœ°å€)

### å±€éƒ¨å˜é‡
1. å­˜æ”¾ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§åŸºæœ¬æ•°æ®ç±»å‹ã€å¯¹è±¡å¼•ç”¨ç±»å‹å’ŒreturnAddressç±»å‹(æŒ‡å‘ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼šå‡½æ•°è¿”å›åœ°å€)
2. å¯èƒ½å¼•èµ·StackOverFlowError => çº¿ç¨‹è¯·æ±‚çš„æ ˆå¸§æ·±åº¦å¤§äºè™šæ‹Ÿæœºæ‰€å…è®¸çš„æ·±åº¦(å‡½æ•°é€’å½’è°ƒç”¨å¯èƒ½è§¦å‘)
3. å¯èƒ½å¼•èµ·OutOfMemorError => è¯¥å‡½æ•°æ ˆæ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜
4. é…ç½®ä¿¡æ¯: -Xms20m -> å †æœ€å°å€¼20Mã€-Xmx20m -> å †æœ€å¤§å€¼20Mã€-Xss -> è®¾ç½®æ ˆå®¹é‡
5. åŒºåˆ†æ ˆå†…åˆ†é…å†…å­˜ç©ºé—´(æ ˆè¿è¡Œå®Œï¼Œè‡ªåŠ¨å›æ”¶ï¼Œä¸å å †ç©ºé—´)ï¼Œå¦‚ä¸‹ä»£ç 

{% highlight Java %}
public class OnStackTest {
    public static void alloc(){
        byte[] b = new byte[2];
        b[0] = 1;
    }
    public static void main(String[] args) {
        long b = System.currentTimeMillis();
        for(int i = 0; i < 100000000; i++){
            alloc();
        }
        long e = System.currentTimeMillis();
        System.out.println(e - b);
    }
}
/** æ ˆå†…åˆ†é…
-server -Xmx10m -Xms10m
-XX:+DoEscapeAnalysis -XX:+PrintGC
è¾“å‡º => 5
*/
/** å †ä¸Šåˆ†é…
-server -Xmx10m -Xms10m
-XX:-DoEscapeAnalysis -XX:+PrintGC
è¾“å‡º => [GC 3550K->478K(10240K), 0.0000977 secs]
[GC 3550K->478K(10240K), 0.0001361 secs]
â€¦â€¦
564
*/
{% endhighlight %}

æ€»ç»“ï¼šå¦‚æœå°å¯¹è±¡ï¼ˆä¸€èˆ¬å‡ åä¸ªbytesï¼‰ï¼Œåœ¨æ²¡æœ‰é€ƒé€¸çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ç›´æ¥åˆ†é…åœ¨æ ˆä¸Šï¼Œå¯ä»¥è‡ªåŠ¨å›æ”¶ï¼Œå‡è½»GCå‹åŠ›(å¤§å¯¹è±¡æˆ–è€…é€ƒé€¸å¯¹è±¡æ— æ³•æ ˆä¸Šåˆ†é…)

### æ“ä½œæ•°æ ˆ
1. åè¿›å…ˆå‡ºLIFOï¼Œæœ€å¤§æ·±åº¦ç”±ç¼–è¯‘æœŸç¡®å®š
2. æ“ä½œæ•°æ ˆå¯ä»¥å­˜æ”¾ä¸€ä¸ªjvmä¸­å®šä¹‰çš„ä»»æ„æ•°æ®ç±»å‹çš„å€¼
3. åœ¨ä»»æ„æ—¶åˆ»ï¼Œæ“ä½œæ•°æ ˆéƒ½ä¸€ä¸ªå›ºå®šçš„æ ˆæ·±åº¦ï¼ŒåŸºæœ¬ç±»å‹é™¤äº†longã€doubleå ç”¨ä¸¤ä¸ªæ·±åº¦ï¼Œå…¶å®ƒå ç”¨ä¸€ä¸ªæ·±åº¦
4. æŒ‡ä»¤ä¸ç»†è¯´äº†...ğŸ˜ˆ

### åŠ¨æ€è¿æ¥
1. æ¯ä¸ªæ ˆå¸§éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± ä¸­è¯¥æ ˆå¸§æ‰€å±æ–¹æ³•çš„å¼•ç”¨ï¼ŒæŒæœ‰è¿™ä¸ªå¼•ç”¨æ˜¯ä¸ºäº†æ”¯æŒæ–¹æ³•è°ƒç”¨è¿‡ç¨‹ä¸­çš„åŠ¨æ€é“¾æ¥
2. Classæ–‡ä»¶çš„å¸¸é‡æ± ä¸­å­˜åœ¨æœ‰å¤§é‡çš„ç¬¦å·å¼•ç”¨ï¼Œå­—èŠ‚ç ä¸­çš„æ–¹æ³•è°ƒç”¨æŒ‡ä»¤å°±ä»¥å¸¸é‡æ± ä¸­æŒ‡å‘æ–¹æ³•çš„ç¬¦å·å¼•ç”¨ä¸ºå‚æ•°
3. é™æ€è§£æ => åœ¨ç±»åŠ è½½é˜¶æ®µæˆ–ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨(å¦‚finalã€staticåŸŸç­‰)
4. åŠ¨æ€è¿æ¥ => è¿è¡Œæ—¶è½¬åŒ–æˆç›´æ¥å¼•ç”¨(åå°„å°±æ˜¯é€šè¿‡è¿™ç§åŠ¨æ€é“¾æ¥æèµ·æ¥çš„ï¼Œåœ¨Javaçš„ä¸–ç•Œä¸­ï¼Œæ— åå°„æ— æ¡†æ¶)

### æ–¹æ³•è¿”å›åœ°å€
1. æ­£å¸¸é€€å‡º => è°ƒç”¨è€…çš„PCè®¡æ•°å™¨çš„å€¼å°±å¯ä»¥ä½œä¸ºè¿”å›åœ°å€ï¼Œæ ˆå¸§ä¸­å¾ˆå¯èƒ½ä¿å­˜äº†è¿™ä¸ªè®¡æ•°å™¨å€¼
2. å¼‚å¸¸é€€å‡º => è¿”å›åœ°å€æ˜¯è¦é€šè¿‡å¼‚å¸¸å¤„ç†å™¨æ¥ç¡®å®šçš„ï¼Œæ ˆå¸§ä¸­ä¸€èˆ¬ä¸ä¼šä¿å­˜è¿™éƒ¨åˆ†ä¿¡æ¯
3. æ–¹æ³•é€€å‡ºçš„è¿‡ç¨‹å®é™…ä¸Šç­‰åŒäºæŠŠå½“å‰æ ˆå¸§å‡ºæ ˆï¼Œå› æ­¤é€€å‡ºæ—¶å¯èƒ½æ‰§è¡Œçš„æ“ä½œæœ‰ï¼šæ¢å¤ä¸Šå±‚æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆï¼Œå¦‚æœæœ‰è¿”å›å€¼ï¼Œåˆ™æŠŠå®ƒå‹å…¥è°ƒç”¨è€…æ ˆå¸§çš„æ“ä½œæ•°æ ˆä¸­ï¼Œè°ƒæ•´PCè®¡æ•°å™¨çš„å€¼ä»¥æŒ‡å‘æ–¹æ³•è°ƒç”¨æŒ‡ä»¤åé¢çš„ä¸€æ¡æŒ‡ä»¤

## Javaå †(å°é‡ç‚¹)

**çº¿ç¨‹å…±äº«**ã€newåˆ›å»ºçš„å¯¹è±¡å®ä¾‹å’Œæ•°ç»„ã€å¸¸é‡(1.7ä»¥å)ã€ç©ºé—´åˆ†ä»£

### åˆ†ä»£ç¤ºæ„å›¾
![image](../../../../public/img/jvm/Javaå †åˆ†ä»£ç¤ºæ„å›¾.png)
1. s0åŒºå’Œs1åŒºç­‰å¤§å°
2. å¯¹è±¡å®ä¾‹åˆ›å»ºååœ¨å †ä¸­é¡ºåº(å¹´é¾„é¡ºåº): edenåŒº -> s0åŒº(s1åŒº) -> tenuredåŒº
3. å¹´é¾„ä¸€èˆ¬æ˜¯æ ¹æ®è¯¥å¯¹è±¡ç»è¿‡å‡ æ¬¡gcåï¼Œæ¥è®¡ç®—å¾—å‡ºã€‚
4. å¤§å¯¹è±¡å¯èƒ½ä¼šç›´æ¥å­˜å‚¨åˆ°è€å¹´ä»£(tenuredåŒº)
5. JVMå›æ”¶å¯¹è±¡æ˜¯æ ¹æ®å¹´é¾„ä»£å’ŒGCç®—æ³•å…±åŒå†³å®šçš„

### åƒåœ¾æ”¶é›†ç®—æ³•
1. æ ‡è®°-æ¸…é™¤ç®—æ³•
2. å¤åˆ¶ç®—æ³•(å›æ”¶æ–°ç”Ÿä»£)
3. æ ‡è®°-æ•´ç†ç®—æ³•(è€å¹´ä»£)
4. åˆ†ä»£æ”¶é›†ç®—æ³•

### å¼•ç”¨åˆ†ç±»
1. å¼ºå¼•ç”¨: Object obj = new Object()
2. è½¯å¼•ç”¨: ç”¨æ¥æè¿°ä¸€äº›è¿˜æœ‰ç”¨ä½†å¹¶éå¿…é¡»çš„å¯¹è±¡ã€‚è§¦å‘æ¡ä»¶ï¼Œåœ¨ç³»ç»Ÿå°†è¦å‘ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸ä¹‹å‰ï¼Œä¼šäºŒæ¬¡å›æ”¶ã€‚SoftReferenceç±»å®ç°è½¯å¼•ç”¨ã€‚
3. å¼±å¼•ç”¨: ä½œç”¨ä¸è½¯å¼•ç”¨ç±»ä¼¼ã€‚è§¦å‘æ¡ä»¶ï¼Œåœ¨ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å‘ç”Ÿä¹‹å‰ï¼Œæ— è®ºå†…å­˜æ˜¯å¦è¶³å¤Ÿã€‚WeakReferenceå®ç°å¼±å¼•ç”¨ã€‚
4. è™šå¼•ç”¨: ä½œç”¨ï¼Œèƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«æ”¶é›†å™¨å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚PhantomReferenceå®ç°è™šå¼•ç”¨ã€‚

### å¯¹è±¡çš„finalizeæ–¹æ³•
1. ä»»ä½•ä¸€ä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•éƒ½åªä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ä¸€æ¬¡
2. è®©è¯¥å¯¹è±¡å¤æ´»æ–¹æ³•ï¼Œéœ€è¦é‡æ–°ä¸å¼•ç”¨é“¾ä¸Šçš„ä»»ä½•ä¸€ä¸ªå¯¹è±¡å»ºç«‹å…³è”
{% highlight Java %}
public class FinalizeEscapeGC {
  public static FinalizeEscapeGC SAVE_HOOK = null;
  public void isAlive() {
    System.out.println("yes, i am still alive :)");
  }
  @Override
  protected void finalize() throws Throwable {
    super.finalize();
    System.out.println("finalize method executed!");
    FinalizeEscapeGC.SAVE_HOOK = this;
  }
  public static void main(String[] args) throws Throwable {
    SAVE_HOOK = new FinalizeEscapeGC();
    SAVE_HOOK = null;
    System.gc();
    // å› ä¸ºfinalizeæ–¹æ³•ä¼˜å…ˆçº§å¾ˆä½ï¼Œæ‰€ä»¥æš‚åœ0.5ç§’ç­‰å¾…å®ƒ
    Thread.sleep(500);
    if (SAVE_HOOK != null) {
      SAVE_HOOK.isAlive();
    } else {
      System.out.println("no, iam dead :(");
    }
    // è‡ªæ•‘å¤±è´¥
    SAVE_HOOK = null;
    System.gc();
    Thread.sleep(500);
    if (SAVE_HOOK != null) {
      SAVE_HOOK.isAlive();
    } else {
      System.out.println("no, iam dead :(");
    }
  }
}
{% endhighlight %}
æ€»ç»“:
1. å¯¹è±¡å¯ä»¥åœ¨è¢«GCæ—¶è‡ªæˆ‘æ‹¯æ•‘ã€‚
2. è¿™ç§è‡ªæ•‘çš„æœºä¼šåªæœ‰ä¸€æ¬¡ï¼Œå› ä¸ºä¸€ä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•æœ€å¤šåªä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ä¸€æ¬¡ã€‚

## æ–¹æ³•åŒº

**çº¿ç¨‹å…±äº«**ã€ä¹Ÿç§°æ°¸ä¹…åŒºã€å­˜å‚¨ç±»ä¿¡æ¯

1. è¿™ä¸ªç±»å‹çš„å®Œæ•´æœ‰æ•ˆå
2. è¿™ä¸ªç±»å‹ç›´æ¥çˆ¶ç±»çš„å®Œæ•´æœ‰æ•ˆå(é™¤éè¿™ä¸ªç±»å‹æ˜¯interfaceæˆ–æ˜¯java.lang.Objectï¼Œä¸¤ç§æƒ…å†µä¸‹éƒ½æ²¡æœ‰çˆ¶ç±»)
3. è¿™ä¸ªç±»å‹çš„ä¿®é¥°ç¬¦(public,abstract, finalçš„æŸä¸ªå­é›†)
4. è¿™ä¸ªç±»å‹ç›´æ¥æ¥å£çš„ä¸€ä¸ªæœ‰åºåˆ—è¡¨
5. ç±»å‹çš„å¸¸é‡æ± ( constant pool)
6. åŸŸ(Field)ä¿¡æ¯
7. æ–¹æ³•(Method)ä¿¡æ¯
8. é™¤äº†å¸¸é‡å¤–çš„æ‰€æœ‰é™æ€(static)å˜é‡

## ç›´æ¥å†…å­˜

åœ¨NIOä¸­ï¼ŒJavaç¨‹åºç›´æ¥ä¸å†…å­˜æ‰“äº¤é“ï¼Œè™½ç„¶æ“ä½œçš„æ˜¯ç›´æ¥å†…å­˜ï¼Œä½†æ˜¯ä¹Ÿä¼šè¢«GCç®—æ³•å›æ”¶åƒåœ¾ç©ºé—´

{% highlight Java %}
// TestDirectByteBuffer
import java.nio.ByteBuffer;
public class TestDirectByteBuffer {
  // -verbose:gc -XX:+PrintGCDetails -XX:MaxDirectMemorySize=40M
  public static void main(String[] args) throws Exception {
    while (true) {
      ByteBuffer buffer = ByteBuffer.allocateDirect(10 * 1024 * 1024);
    }
  }
}
// TestUnsafeMemo
import sun.misc.Unsafe;
public class TestUnsafeMemo {
  // -XX:MaxDirectMemorySize=40M
  public static void main(String[] args) throws Exception {
    Unsafe unsafe = GetUsafeInstance.getUnsafeInstance();
    while (true) {
      long pointer = unsafe.allocateMemory(1024 * 1024 * 20);
      System.out.println(unsafe.getByte(pointer + 1));
      // å¦‚æœä¸é‡Šæ”¾å†…å­˜,è¿è¡Œä¸€æ®µæ—¶é—´ä¼šæŠ¥é”™java.lang.OutOfMemoryError
      // unsafe.freeMemory(pointer);
    }
  }
}
// å€Ÿé‰´http://blog.csdn.net/aitangyong/article/details/39323125ä¾‹å­
{% endhighlight %}
æ€»ç»“
1. TestDirectByteBufferä¼šä¸åœå»è§¦å‘GCæ“ä½œ
2. TestUnsafeMemoä¸ä¼šè§¦å‘GCæ“ä½œ
3. å› æ­¤: Unsafeåˆ†é…ç›´æ¥å†…å­˜ï¼Œéœ€è¦æ‰‹åŠ¨å›æ”¶å†…å­˜ç©ºé—´
